#!/bin/bash
# Install Comprehensive Pentesting Tools
# Kali Linux, Parrot OS, and BlackArch tools
# EDUCATIONAL PURPOSES ONLY

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LOG_FILE="/var/log/ghostpi-pentest-install.log"

# Educational Disclaimer
DISCLAIMER="
╔═══════════════════════════════════════════════════════════════╗
║           ⚠️  EDUCATIONAL PURPOSES ONLY ⚠️                    ║
║                                                               ║
║  All tools in this distribution are for EDUCATIONAL and      ║
║  AUTHORIZED TESTING purposes only.                            ║
║                                                               ║
║  Unauthorized access to computer systems is ILLEGAL.          ║
║  You are responsible for your actions.                       ║
║  Use only on systems you own or have explicit permission.    ║
╚═══════════════════════════════════════════════════════════════╝
"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

echo "$DISCLAIMER"
echo ""
read -p "Do you understand and agree to use these tools responsibly? (yes/no): " agree
if [ "$agree" != "yes" ]; then
    echo "Installation cancelled."
    exit 1
fi

log "Starting comprehensive pentesting tools installation..."

# Update system
log "Updating package lists..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -qq

# Add Kali Linux repositories (where compatible)
log "Adding Kali Linux repositories..."
if ! grep -q "kali" /etc/apt/sources.list.d/kali.list 2>/dev/null; then
    cat > /etc/apt/sources.list.d/kali.list <<EOF
# Kali Linux tools repository (ARM compatible)
deb http://http.kali.org/kali kali-rolling main contrib non-free
EOF
    wget -q -O - https://archive.kali.org/archive-key.asc | apt-key add - 2>/dev/null || true
fi

# Add Parrot OS repositories (where compatible)
log "Adding Parrot OS repositories..."
if ! grep -q "parrot" /etc/apt/sources.list.d/parrot.list 2>/dev/null; then
    cat > /etc/apt/sources.list.d/parrot.list <<EOF
# Parrot OS tools repository (ARM compatible)
deb https://deb.parrot.sh/parrot/ rolling main contrib non-free
EOF
    wget -q -O - https://deb.parrot.sh/parrot/parrot.gpg | apt-key add - 2>/dev/null || true
fi

# Add BlackArch repositories (where compatible)
log "Adding BlackArch repositories..."
if ! grep -q "blackarch" /etc/apt/sources.list.d/blackarch.list 2>/dev/null; then
    # BlackArch is primarily x86_64, but we'll try ARM packages where available
    # Most tools will be installed from Debian/Kali repos
    echo "# BlackArch tools (installed via compatible sources)" > /etc/apt/sources.list.d/blackarch.list
fi

apt-get update -qq

# Install core pentesting tools (Kali Linux)
log "Installing Kali Linux tools..."
KALI_TOOLS=(
    # Information Gathering
    "nmap" "masscan" "zmap" "recon-ng" "maltego" "theharvester" "dnsrecon"
    "dnsenum" "fierce" "dnswalk" "dnsmap" "dnstracer" "amass" "sublist3r"
    
    # Vulnerability Assessment
    "nikto" "openvas" "lynis" "nuclei" "golismero" "skipfish" "wapiti"
    "wpscan" "joomscan" "drupwn" "plecost" "w3af"
    
    # Web Application Analysis
    "burpsuite" "owasp-zap" "sqlmap" "commix" "websploit" "wfuzz"
    "dirb" "dirbuster" "gobuster" "ffuf" "feroxbuster" "wfuzz"
    
    # Password Attacks
    "john" "hashcat" "hydra" "medusa" "ncrack" "patator" "crunch"
    "cewl" "rsmangler" "wordlists" "rockyou" "hash-identifier"
    
    # Wireless Attacks
    "aircrack-ng" "reaver" "bully" "wifite" "kismet" "wireshark"
    "tshark" "bettercap" "hostapd-wpe" "mdk4" "pixiewps"
    
    # Exploitation Tools
    "metasploit-framework" "exploitdb" "searchsploit" "armitage"
    "routersploit" "beef-xss" "setoolkit" "backdoor-factory"
    
    # Post Exploitation
    "powersploit" "empire" "veil" "unicorn" "weevely" "webshells"
    
    # Sniffing & Spoofing
    "ettercap-text-only" "dsniff" "yersinia" "responder" "bettercap"
    "netdiscover" "netmask" "scapy" "tcpdump"
    
    # Forensics
    "autopsy" "sleuthkit" "volatility" "binwalk" "foremost" "testdisk"
    "photorec" "scalpel" "bulk-extractor" "regripper"
    
    # Reporting Tools
    "dradis" "faraday" "magic-tree" "pipal" "keepnote"
    
    # Social Engineering
    "social-engineer-toolkit" "beef-xss" "phishing-frenzy"
    
    # Reverse Engineering
    "radare2" "ghidra" "apktool" "dex2jar" "jd-gui" "jadx"
    
    # Stress Testing
    "thc-ssl-dos" "slowhttptest" "hping3" "siege" "tsunami"
    
    # VoIP
    "sipvicious" "voiphopper" "siparmyknife"
    
    # Bluetooth
    "bluetooth" "bluelog" "bluebugger" "bluesnarfer" "bluewalker"
    
    # RFID/NFC
    "libnfc" "mfoc" "mfcuk" "nfc-list" "proxmark3"
    
    # Other Tools
    "netcat" "socat" "ncat" "proxychains4" "tor" "anonsurf"
    "gparted" "testdisk" "photorec" "ddrescue" "testdisk"
)

# Install Parrot OS tools
log "Installing Parrot OS tools..."
PARROT_TOOLS=(
    "anonsurf" "parrot-updater" "parrot-menu" "parrot-tools"
    "pwnat" "proxychains4" "tor" "torbrowser-launcher"
)

# Install BlackArch tools (via compatible sources)
log "Installing BlackArch-compatible tools..."
BLACKARCH_TOOLS=(
    # These will be installed from Debian/Kali repos where ARM compatible
    "sqlmap" "metasploit-framework" "nmap" "wireshark" "aircrack-ng"
    "john" "hashcat" "hydra" "burpsuite" "owasp-zap"
)

# Function to install tools with error handling
install_tool_group() {
    local group_name="$1"
    shift
    local tools=("$@")
    
    log "Installing $group_name tools..."
    local installed=0
    local failed=0
    
    for tool in "${tools[@]}"; do
        if apt-get install -y "$tool" >/dev/null 2>&1; then
            installed=$((installed + 1))
            log "  ✓ $tool"
        else
            failed=$((failed + 1))
            log "  ✗ $tool (not available for ARM or not in repos)"
        fi
    done
    
    log "$group_name: $installed installed, $failed failed"
}

# Install tool groups
install_tool_group "Kali Linux" "${KALI_TOOLS[@]}"
install_tool_group "Parrot OS" "${PARROT_TOOLS[@]}"
install_tool_group "BlackArch" "${BLACKARCH_TOOLS[@]}"

# Install additional tools from source/build
log "Installing additional tools from source..."

# Install gobuster (if not available)
if ! command -v gobuster &> /dev/null; then
    log "Installing gobuster from source..."
    go install github.com/OJ/gobuster/v3@latest 2>/dev/null || true
fi

# Install ffuf (if not available)
if ! command -v ffuf &> /dev/null; then
    log "Installing ffuf from source..."
    go install github.com/ffuf/ffuf/v2@latest 2>/dev/null || true
fi

# Install nuclei (if not available)
if ! command -v nuclei &> /dev/null; then
    log "Installing nuclei from source..."
    go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest 2>/dev/null || true
fi

# Install wordlists
log "Installing wordlists..."
mkdir -p /usr/share/wordlists
if [ ! -f /usr/share/wordlists/rockyou.txt ]; then
    log "Downloading rockyou.txt..."
    wget -q -O /usr/share/wordlists/rockyou.txt.gz \
        https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt.tar.gz 2>/dev/null || \
    gunzip -c /usr/share/wordlists/rockyou.txt.gz > /usr/share/wordlists/rockyou.txt 2>/dev/null || true
fi

# Create tool categories menu
log "Creating pentesting tools menu..."
mkdir -p /usr/local/bin
cat > /usr/local/bin/pentest-menu.sh <<'MENU'
#!/bin/bash
# GhostPi Pentesting Tools Menu
# EDUCATIONAL PURPOSES ONLY

echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║        GhostPi Pentesting Tools Menu                         ║"
echo "║        Kali | Parrot | BlackArch Tools                        ║"
echo "║        ⚠️  EDUCATIONAL PURPOSES ONLY ⚠️                      ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo ""
echo "1. Information Gathering"
echo "2. Vulnerability Assessment"
echo "3. Web Application Analysis"
echo "4. Password Attacks"
echo "5. Wireless Attacks"
echo "6. Exploitation Tools"
echo "7. Post Exploitation"
echo "8. Sniffing & Spoofing"
echo "9. Forensics"
echo "10. Social Engineering"
echo "11. Reverse Engineering"
echo "12. Flipper Zero Tools"
echo "13. Exit"
echo ""
read -p "Select category: " choice

case $choice in
    1) echo "nmap, masscan, recon-ng, theharvester, dnsrecon, amass" ;;
    2) echo "nikto, openvas, lynis, nuclei, wpscan" ;;
    3) echo "burpsuite, sqlmap, commix, wfuzz, gobuster" ;;
    4) echo "john, hashcat, hydra, medusa, crunch" ;;
    5) echo "aircrack-ng, reaver, wifite, bettercap" ;;
    6) echo "metasploit-framework, exploitdb, routersploit" ;;
    7) echo "powersploit, empire, veil" ;;
    8) echo "ettercap, bettercap, responder, wireshark" ;;
    9) echo "autopsy, volatility, binwalk, testdisk" ;;
    10) echo "setoolkit, beef-xss" ;;
    11) echo "radare2, ghidra, apktool" ;;
    12) flipper-zero-menu.sh ;;
    13) exit 0 ;;
    *) echo "Invalid choice" ;;
esac
MENU

chmod +x /usr/local/bin/pentest-menu.sh

# Create Flipper Zero integration script
log "Creating Flipper Zero integration..."
cat > /usr/local/bin/flipper-pentest.sh <<'FLIPPER'
#!/bin/bash
# Flipper Zero Pentesting Integration
# EDUCATIONAL PURPOSES ONLY

FLIPPER_MOUNT="/mnt/flipper"
TOOLS_DIR="/opt/flipper-pentest-tools"

echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║     Flipper Zero + Pentesting Tools Integration              ║"
echo "║     ⚠️  EDUCATIONAL PURPOSES ONLY ⚠️                          ║"
echo "╚═══════════════════════════════════════════════════════════════╝"

# Check if Flipper is connected
if ! flipper-detector.sh >/dev/null 2>&1; then
    echo "Flipper Zero not detected. Please connect your Flipper Zero."
    exit 1
fi

echo "Flipper Zero detected!"
echo ""
echo "Available integrations:"
echo "1. Push pentesting wordlists to Flipper"
echo "2. Sync brute force tools"
echo "3. Install Marauder WiFi tools"
echo "4. Generate BadUSB payloads"
echo "5. Create RFID/NFC attack files"
echo ""

read -p "Select option: " choice

case $choice in
    1)
        echo "Pushing wordlists to Flipper..."
        mkdir -p "$FLIPPER_MOUNT/wordlists"
        cp /usr/share/wordlists/*.txt "$FLIPPER_MOUNT/wordlists/" 2>/dev/null || true
        echo "✓ Wordlists pushed"
        ;;
    2)
        echo "Syncing brute force tools..."
        flipper-sync.sh push
        ;;
    3)
        echo "Setting up Marauder..."
        marauder-setup.sh install
        ;;
    4)
        echo "Generating BadUSB payload..."
        # Use existing BadUSB generator
        brute-force-helper.sh badusb
        ;;
    5)
        echo "Creating RFID/NFC files..."
        # Generate RFID attack files
        echo "Use Flipper Zero's built-in RFID tools"
        ;;
esac
FLIPPER

chmod +x /usr/local/bin/flipper-pentest.sh

log "✓ Pentesting tools installation complete!"
log ""
log "Installed tools from:"
log "  - Kali Linux"
log "  - Parrot OS"
log "  - BlackArch (ARM compatible)"
log ""
log "Access tools via: pentest-menu.sh"
log "Flipper integration: flipper-pentest.sh"
log ""
log "⚠️  REMEMBER: EDUCATIONAL PURPOSES ONLY ⚠️"

echo ""
echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║           Installation Complete!                              ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo ""
echo "Access tools: pentest-menu.sh"
echo "Flipper integration: flipper-pentest.sh"
echo ""
echo "⚠️  EDUCATIONAL PURPOSES ONLY ⚠️"

