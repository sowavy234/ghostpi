name: Build GhostPi Images

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      cm_type:
        description: 'Compute Module Type'
        required: true
        default: 'CM5'
        type: choice
        options:
        - CM4
        - CM5
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 python3-pip \
          device-tree-compiler \
          plymouth plymouth-themes \
          imagemagick \
          git \
          dosfstools \
          fdisk \
          parted \
          kpartx \
          qemu-utils \
          xinput-calibrator \
          coreutils \
          || true
    
    - name: Clone LinuxBootImageFileGenerator
      run: |
        git clone https://github.com/robseb/LinuxBootImageFileGenerator.git /tmp/LinuxBootImageFileGenerator
    
    - name: Clone HackberryPi CM5 Repository
      run: |
        git clone https://github.com/ZitaoTech/HackberryPiCM5.git $HOME/Downloads/hackberrypicm5-main || true
    
    - name: Build CM5 Image
      if: github.event.inputs.cm_type == 'CM5' || (github.event.inputs.cm_type == '' && github.event_name == 'workflow_dispatch') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
      run: |
        cd "${{ github.workspace }}"
        chmod +x scripts/*.sh
        sudo -E env OUTPUT_DIR="${{ github.workspace }}" HACKBERRY_REPO="$HOME/Downloads/hackberrypicm5-main" ./scripts/build_hackberry_integrated.sh CM5
      timeout-minutes: 45
    
    - name: Build CM4 Image
      if: github.event.inputs.cm_type == 'CM4'
      run: |
        cd "${{ github.workspace }}"
        chmod +x scripts/*.sh
        sudo -E env OUTPUT_DIR="${{ github.workspace }}" HACKBERRY_REPO="$HOME/Downloads/hackberrypicm5-main" ./scripts/build_hackberry_integrated.sh CM4
      timeout-minutes: 45
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ghostpi-images
        path: |
          ${{ github.workspace }}/GhostPi-*.img
          ${{ github.workspace }}/GhostPi-*.img.gz
          ${{ github.workspace }}/**/GhostPi-*.img
          ${{ github.workspace }}/**/GhostPi-*.img.gz
        retention-days: 7
        if-no-files-found: warn
    
    - name: Create Release
      if: (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true') || (github.event_name == 'push' && contains(github.ref, 'refs/heads/main'))
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.2.0
        name: GhostPi v1.2.0 - HackberryPi CM5 Edition
        body: |
          ## GhostPi v1.2.0 - HackberryPi CM5 Edition
          
          ### Features
          - Custom 3D boot splash (Welcome to Wavy's World)
          - HackberryPi CM5 full support (power, touchscreen, battery, LED, speakers)
          - Battery monitoring via I2C (like HackberryPi CM5)
          - AI companion with system graphs (like Parrot OS)
          - Enhanced terminal with system info banner
          - Flipper Zero auto-launch terminal
          - Comprehensive pentesting tools (Kali, Parrot, BlackArch)
          - Auto-update system with wavy-update menu
          - Self-healing service
          - Swapfile management
          - Universal Raspberry Pi support (CM4, CM5, Pi 4, Pi 5)
          
          ### Installation
          1. Download the .img file
          2. Flash to SD card using Raspberry Pi Imager or dd
          3. Insert into HackberryPi CM5
          4. Power on with Call button
          5. First boot auto-configures everything
          
          ### Hardware Reference
          Based on: https://github.com/ZitaoTech/HackberryPiCM5
          
          See [RELEASE_v1.2.0.md](RELEASE_v1.2.0.md) for full details.
          
          ⚠️ **EDUCATIONAL PURPOSES ONLY**
        files: |
          ${{ github.workspace }}/GhostPi-*.img
          ${{ github.workspace }}/GhostPi-*.img.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

